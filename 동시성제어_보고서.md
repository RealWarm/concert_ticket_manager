# 동시성 제어 조사 및 테스트 보고서

### [1] Lock에 대한 조사

**[비관락 : Reapeatable Read 또는 Serializable 정도의 격리성 수준을 제공한다]**

- 트랜잭션이 시작될 때 Shared Lock 또는 Exclusive Lock을 걸고 시작한다.


- 공유락 : Read Lock이라고도 불리는 공유락은 트랜잭션이 읽기를 할때 사용하는 락이며, 데이터를 읽기만하기 때문에 같은 공유락끼리는 동시에 접근이 가능하지만, write 작업은 막는다.


- 배타락 : Write Lock이라고 불리며, 데이터를 변경할 때 사용하는 락이다.
  트랜잭션이 완료될 때까지 유지되며, 배타락이 끝나기 전까지 read/write를 모두 막는다.
  (주의! 단순 조회는 허용한다!)
  
- Lock을 얻는 순서대로 요청을 처리한다.


- **장  점** : 충돌을 확실하게 방지할 수 있어 데이터 무결성을 높게 유지 가능

- **단  점** : 락이 걸리는 동안 다른 트랜잭션의 접근이 제한되어 성능 저하 발생 가능


**[낙관락 : 자원에 락을 걸지 않고, 동시성 문제가 발생하면 그때 처리한다.]**

- DB Lock을 사용하지 않고 Version관리를 통해 애플리케이션레벨에서 처리 한다.


- 트랜잭션 커밋 전 트랜잭션 충돌을 알 수 없다.


- 최초 하나의 요청만 성공하고 나머지 요청은 ObjectOptimisticLockingFailureException 예외를 발생시킨다.


- **장  점** : 트랜잭션을 필요로 하지 않는다. 비관적락보다 성능이 좋음.

- **단  점** : 충돌이 발생하면 개발자가 수동으로 롤백처리를 해줘야 한다는 단점이 있다.



### [2] Lock에 대한 이해 및 적용 기준

처음에는 충돌이 많으면 비관락, 충돌이 적으면 낙관락을 사용한다 생각했다.

뭔가 충돌이 많아도 낙관락이 될거 같은데 하는 의구심이 한가득이었다.

하지만 멘토링을 통해서 정말 명확한 기준을 알게 되었다.

-----------------------
(1) A, B, C 중에 한명만 성공하면 됨 - 낙관락 + 재시도 X ( 나머지 2명 Fail 하고 아무런 처리안해도됨 )

(2) A, B, C 다 성공해야 됨

(2-1) 실패한 애가 성공을 위해서 "재시도" 를 할 것이냐 ( 낙관락 + 재시도 )    

(2-2) 성공하기 위해서 안겹치게 기다릴 것이냐 [ 정합성이 너무 중요한 데이터 ] ( 비관락 )

-----------------------
20개가 넘는 블로그를 읽어봤는데 위와 같은 명쾌한 답변이 없었다.

정말 저 설명을 듣자마자 유레카를 외쳤다(유레카!)

아래의 시나리오 Lock 설정 기준은 위를 참조하여 진행하였다.




### [3] 동시성 문제 발생 추측 및 적용 계획

- 충전(낙관락)

  비즈니스 로직 : 한 유저가 따닥(많아야 3~4건) 여러번 충전을 시도하면 한건만 성공시킨다.

  해당 로직에서 비관적락을 사용하게 된다면, 실수도 여러번 클릭한 요청도 순차적으로 요청을 수행하게 된다. 
  그렇게 되면 의도하지 않은 요청까지 포인트 내역 테이블에 쌓이게 된다. 
  이는 의도한 비즈니스 로직을 만족하지 못하여 "낙관락"을 선택하게 되었습니다.


  - 실험결과 : 비관락은 비즈니스 로직을 만족못해서 실패, 낙관락은 성공! (낙관락 채택)

---
- 결제(낙관락)
  비즈니스 로직 : 한 유저가 따닥(많아야 3~4건) 여러번 결제를 시도하면 한건만 성공시킨다.
  원하는 목표는 결제 1건만 성공시키면되는 낙관적락과 비관적락 모두 원하는 동작을 얻을 수 있었다.

  실험결과 : 낙관/비관 둘다 동일한 결과가 나오지만 성능상 이점을 보여준 낙관락을 선택하였습니다.

---
- 예약(낙관락)
  비즈니스 로직 : 여러명의 유저가 동시에 한 좌석의 예약을 시도할때, 한명의 예약만 성공시킨다.
  정말 오해가 많았었다. 비관락을 하면 배타락이 걸려서 다른 유저는 조회도 안되는 줄 알았다.
  하지만 배타락이 걸려도 단순 조회가 가능하다는 것을 알게 되었다.

  실험결과 : 낙관/비관 둘다 동일한 결과가 나오지만 성능상 이점을 보여준 낙관락을 선택하였습니다.

